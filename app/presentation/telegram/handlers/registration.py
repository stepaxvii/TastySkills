import os
import logging
from aiogram import Router, F
from aiogram.types import Message, CallbackQuery
from aiogram.filters import Command
from aiogram.fsm.context import FSMContext
from app.domain.entities.telegram_states import RegistrationStates
from app.application.services.telegram_service import TelegramService
from app.presentation.telegram.keyboards import get_registration_choice_keyboard, get_manager_menu_keyboard
from app.infrastructure.database.database import SessionLocal
from app.infrastructure.repositories.crud import get_user_by_telegram_id, get_user_by_username, create_user
from app.domain.entities.schemas import UserCreate
from dotenv import load_dotenv

load_dotenv()

ADMIN_ID = os.getenv("ADMIN_ID", "861742986")
ADMIN_USERNAME = os.getenv("ADMIN_USERNAME", "boba")
ADMIN_PASSWORD = os.getenv("ADMIN_PASSWORD", "paper1234")

logger = logging.getLogger(__name__)
registration_router = Router()

@registration_router.message(Command("start"))
async def cmd_start(message: Message, state: FSMContext) -> None:
    user_id = message.from_user.id # type: ignore
    db = SessionLocal()
    try:
        if str(user_id) == ADMIN_ID:
            admin = get_user_by_username(db, ADMIN_USERNAME)
            if not admin:
                user_data = UserCreate(
                    username=ADMIN_USERNAME,
                    password=ADMIN_PASSWORD,
                    role="admin"
                )
                create_user(db, user_data)
                await message.answer(f"‚úÖ\n–õ–æ–≥–∏–Ω: {ADMIN_USERNAME}\n–ü–∞—Ä–æ–ª—å: {ADMIN_PASSWORD}")
                return
            else:
                await message.answer(f"üëë –ê–∫–∫–∞—É–Ω—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ {ADMIN_USERNAME} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.")
                return
        user = get_user_by_telegram_id(db, user_id)
        if user:
            if user.role == "admin":  # type: ignore
                await message.answer(
                    f"üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {user.telegram_first_name or user.username}!\n\n"
                    f"üëë –†–æ–ª—å: –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä\n"
                    f"üîó –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å: http://...\n\n"
                    f"–í—ã –º–æ–∂–µ—Ç–µ —É–ø—Ä–∞–≤–ª—è—Ç—å –≤—Å–µ–π —Å–∏—Å—Ç–µ–º–æ–π —á–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å."
                )
            elif user.role == "manager":  # type: ignore
                await message.answer(
                    f"üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {user.telegram_first_name or user.username}!\n\n"
                    f"üëë –†–æ–ª—å: –ú–µ–Ω–µ–¥–∂–µ—Ä\n"
                    f"üîó –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å: http://...\n\n"
                    f"–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –Ω–∏–∂–µ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è:",
                    reply_markup=get_manager_menu_keyboard()
                )
            else:  # waiter
                await message.answer(
                    f"üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {user.telegram_first_name or user.username}!\n\n"
                    f"üë§ –†–æ–ª—å: –û—Ñ–∏—Ü–∏–∞–Ω—Ç\n"
                    f"üîó –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å: http://...\n\n"
                    f"–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–µ–Ω—é."
                )
            return
        start_param = message.text.split()[1] if message.text and len(message.text.split()) > 1 else None
        if start_param and start_param.startswith("invite_"):
            invitation_code = start_param[7:]
            invitation_data = TelegramService.process_invitation_code(db, invitation_code)
            if invitation_data:
                if invitation_data["type"] == "manager_link":
                    await state.update_data(
                        registration_type="waiter",
                        manager_id=invitation_data["manager_id"]
                    )
                    await state.set_state(RegistrationStates.waiting_for_username)
                    await message.answer(
                        f"üë§ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—é –º–µ–Ω–µ–¥–∂–µ—Ä–∞\n\n"
                        f"‚úÖ –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –ø—Ä–∏–Ω—è—Ç–æ!\n"
                        f"–ú–µ–Ω–µ–¥–∂–µ—Ä: {invitation_data['manager_username']}\n"
                        f"–í—ã –±—É–¥–µ—Ç–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –∫–∞–∫ –æ—Ñ–∏—Ü–∏–∞–Ω—Ç.\n\n"
                        f"–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –¥–ª—è –≤—Ö–æ–¥–∞ –≤ —Å–∏—Å—Ç–µ–º—É:\n(—Ä–∞–∑—Ä–µ—à–µ–Ω—ã —Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ —Å–∏–º–≤–æ–ª—ã)"
                    )
                else:
                    await state.update_data(
                        registration_type="waiter",
                        invitation_id=invitation_data["invitation_id"],
                        manager_id=invitation_data["manager_id"]
                    )
                    await state.set_state(RegistrationStates.waiting_for_username)
                    await message.answer(
                        f"üë§ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—é\n\n"
                        f"‚úÖ –ö–æ–¥ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è –ø—Ä–∏–Ω—è—Ç!\n"
                        f"–í—ã –±—É–¥–µ—Ç–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –∫–∞–∫ –æ—Ñ–∏—Ü–∏–∞–Ω—Ç.\n\n"
                        f"–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –¥–ª—è –≤—Ö–æ–¥–∞ –≤ —Å–∏—Å—Ç–µ–º—É:\n(—Ä–∞–∑—Ä–µ—à–µ–Ω—ã —Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ —Å–∏–º–≤–æ–ª—ã)"
                    )
            else:
                await message.answer(
                    "‚ùå –ù–µ–≤–µ—Ä–Ω–∞—è —Å—Å—ã–ª–∫–∞ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è.\n\n"
                    "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:",
                    reply_markup=get_registration_choice_keyboard()
                )
                await state.set_state(RegistrationStates.waiting_for_registration_choice)
        else:
            await message.answer(
                "ü§ñ TastySkills Bot\n\n"
                "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –î–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è.\n\n"
                "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:",
                reply_markup=get_registration_choice_keyboard()
            )
            await state.set_state(RegistrationStates.waiting_for_registration_choice)
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∫–æ–º–∞–Ω–¥—ã start: {e}")
        await message.answer("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.")
    finally:
        db.close()

@registration_router.callback_query(lambda c: c.data in ["register_manager", "register_invitation"])
async def process_registration_choice(callback_query: CallbackQuery, state: FSMContext) -> None:
    await callback_query.answer()
    if callback_query.data == "register_manager":
        await state.update_data(registration_type="manager")
        await state.set_state(RegistrationStates.waiting_for_username)
        if callback_query.message:
            await callback_query.message.answer(
                "üëë –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞\n\n"
                "–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –¥–ª—è –≤—Ö–æ–¥–∞ –≤ —Å–∏—Å—Ç–µ–º—É:\n(—Ä–∞–∑—Ä–µ—à–µ–Ω—ã —Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ —Å–∏–º–≤–æ–ª—ã)"
            )
    else:
        await state.update_data(registration_type="waiter")
        await state.set_state(RegistrationStates.waiting_for_invitation)
        if callback_query.message:
            await callback_query.message.answer(
                "üë§ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—é\n\n"
                "–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è –æ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–∞:"
            )

@registration_router.message(RegistrationStates.waiting_for_invitation)
async def process_invitation(message: Message, state: FSMContext) -> None:
    invitation_code = message.text.strip() if message.text else ""
    db = SessionLocal()
    try:
        invitation_data = TelegramService.process_invitation_code(db, invitation_code)
        if invitation_data:
            if invitation_data["type"] == "manager_link":
                await state.update_data(
                    manager_id=invitation_data["manager_id"]
                )
            else:
                await state.update_data(
                    invitation_id=invitation_data["invitation_id"],
                    manager_id=invitation_data["manager_id"]
                )
            await state.set_state(RegistrationStates.waiting_for_username)
            await message.answer(
                "‚úÖ –ö–æ–¥ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è –ø—Ä–∏–Ω—è—Ç!\n\n"
                "–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –¥–ª—è –≤—Ö–æ–¥–∞ –≤ —Å–∏—Å—Ç–µ–º—É:\n(—Ä–∞–∑—Ä–µ—à–µ–Ω—ã —Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ —Å–∏–º–≤–æ–ª—ã)"
            )
        else:
            await message.answer(
                "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è.\n"
                "–ü–æ–ø—Ä–æ—Å–∏—Ç–µ –≤–∞—à–µ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –≤—ã—Å–ª–∞—Ç—å —Å—Å—ã–ª–∫—É –¥–ª—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è."
            )
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è: {e}")
        await message.answer("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.")
    finally:
        db.close()

@registration_router.message(RegistrationStates.waiting_for_username)
async def process_username(message: Message, state: FSMContext) -> None:
    username = message.text.strip() if message.text else ""
    is_valid, error_msg = TelegramService.validate_username(username)
    if not is_valid:
        await message.answer(f"‚ùå {error_msg}\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑:")
        return
    await state.update_data(username=username)
    await state.set_state(RegistrationStates.waiting_for_password)
    await message.answer(
        "–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è –≤—Ö–æ–¥–∞ –≤ —Å–∏—Å—Ç–µ–º—É:\n"
        "(–º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤)"
    )

@registration_router.message(RegistrationStates.waiting_for_password)
async def process_password(message: Message, state: FSMContext) -> None:
    password = message.text if message.text else ""
    is_valid, error_msg = TelegramService.validate_password(password)
    if not is_valid:
        await message.answer(f"‚ùå {error_msg}\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑:")
        return
    await state.update_data(password=password)
    user_data = await state.get_data()
    registration_type = user_data.get('registration_type', 'waiter')
    if registration_type == "manager":
        await complete_registration(message, state, "manager")
    else:
        await complete_registration(message, state, "waiter")

async def complete_registration(message: Message, state: FSMContext, role: str = "waiter") -> None:
    user_data = await state.get_data()
    username = user_data.get('username')
    password = user_data.get('password')
    logger.info(f"–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: username={username}, role={role}")
    if not username or not password:
        await message.answer("‚ùå –û—à–∏–±–∫–∞: –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏")
        return
    logger.info(f"–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {username}, —Ä–æ–ª—å: {role}")
    db = SessionLocal()
    try:
        assert message.from_user is not None
        telegram_data = {
            'id': message.from_user.id,
            'username': message.from_user.username,
            'first_name': message.from_user.first_name,
            'last_name': message.from_user.last_name
        }
        user = TelegramService.register_user(
            db=db,
            username=username,
            password=password,
            role=role,
            telegram_data=telegram_data,
            manager_id=user_data.get('manager_id'),
            invitation_id=user_data.get('invitation_id')
        )
        logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω —Å ID: {user.id}")
        if role == "manager":
            await message.answer(
                f"üéâ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!\n\n"
                f"üë§ –õ–æ–≥–∏–Ω: {username}\n"
                f"üëë –†–æ–ª—å: –ú–µ–Ω–µ–¥–∂–µ—Ä\n\n"
                f"–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è –¥–ª—è –æ—Ñ–∏—Ü–∏–∞–Ω—Ç–æ–≤.\n"
                f"–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É 'üìã –°—Å—ã–ª–∫–∞ –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏'",
                reply_markup=get_manager_menu_keyboard()
            )
        else:
            await message.answer(
                f"üéâ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!\n\n"
                f"üë§ –õ–æ–≥–∏–Ω: {username}\n"
                f"üëë –†–æ–ª—å: –û—Ñ–∏—Ü–∏–∞–Ω—Ç\n\n"
                f"–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–µ–Ω—é.\n"
                f"–ü–µ—Ä–µ–π–¥–∏—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ: http://..."
            )
        await state.clear()
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {e}")
        await message.answer("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.")
    finally:
        db.close() 